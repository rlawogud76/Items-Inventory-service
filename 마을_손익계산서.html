<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ë§ˆì„ ê³µë™ì€í–‰ ì†ìµê³„ì‚°ì„œ</title>
<style>
* { box-sizing: border-box; }
body { 
    font-family: ë§‘ì€ ê³ ë”•, Arial; 
    background: #212121;
    color: #ececec;
    padding: 20px;
    min-height: 100vh;
}
.container { max-width: 900px; margin: 0 auto; }
h1 { 
    text-align: center; 
    color: #ececec; 
    margin-bottom: 5px;
    font-weight: 500;
}
.subtitle { text-align: center; color: #8e8e8e; margin-bottom: 20px; }
.info-bar {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.info-bar input {
    padding: 12px 16px;
    border: 1px solid #3a3a3a;
    border-radius: 24px;
    background: #2f2f2f;
    color: #ececec;
    flex: 1;
    min-width: 200px;
}
.info-bar input:focus {
    outline: none;
    border-color: #5a5a5a;
}
.info-bar input::placeholder { color: #8e8e8e; }
table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-bottom: 20px;
    background: #2f2f2f;
    border-radius: 12px;
    overflow: hidden;
}
th, td { 
    border: 1px solid #3a3a3a; 
    padding: 12px; 
    text-align: center; 
}
th { 
    background: #383838; 
    color: #ececec; 
    font-weight: 500;
}
.section-title {
    background: #2f2f2f;
    color: #ececec;
    font-size: 1em;
    padding: 14px 18px;
    margin-top: 24px;
    border-radius: 12px 12px 0 0;
    font-weight: 500;
    border: 1px solid #3a3a3a;
    border-bottom: none;
}
input[type="number"], input[type="text"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #3a3a3a;
    border-radius: 8px;
    background: #383838;
    color: #ececec;
    text-align: center;
}
input[type="number"]:focus, input[type="text"]:focus {
    outline: none;
    border-color: #5a5a5a;
    background: #404040;
}
input[type="number"]::placeholder, input[type="text"]::placeholder { color: #8e8e8e; }
.total-row { 
    background: #383838 !important; 
    font-weight: 500; 
}
.total-row td { color: #ececec; font-size: 1.05em; }
.profit-positive { background: #2a3a2a !important; color: #a0c0a0 !important; }
.profit-negative { background: #3a2a2a !important; color: #c0a0a0 !important; }
.summary-card {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin: 20px 0;
}
.card {
    background: #2f2f2f;
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    border: 1px solid #3a3a3a;
}
.card-label { color: #8e8e8e; font-size: 0.85em; margin-bottom: 8px; }
.card-value { font-size: 1.6em; font-weight: 500; }
.card-income { border-left: none; }
.card-income .card-value { color: #8bc38b; }
.card-expense { border-left: none; }
.card-expense .card-value { color: #c38b8b; }
.card-profit { border-left: none; }
.card-profit .card-value { color: #ececec; }
.btn-group {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
}
.btn {
    padding: 10px 18px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: 500;
    transition: background 0.2s;
}
.btn:hover { opacity: 0.85; }
.btn-save { background: #4a4a4a; color: #ececec; }
.btn-load { background: #4a4a4a; color: #ececec; }
.btn-clear { background: #3a3a3a; color: #b0b0b0; }
.btn-add { background: #4a4a4a; color: #ececec; }
.btn-export { background: #4a4a4a; color: #ececec; }
.delete-btn {
    background: #353535;
    color: #a0a0a0;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 0.85em;
}
.delete-btn:hover { background: #4a4a4a; color: #ececec; }
.history-section {
    background: #2f2f2f;
    border-radius: 12px;
    padding: 15px;
    margin-top: 20px;
    border: 1px solid #3a3a3a;
}
.history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #3a3a3a;
}
.history-item:last-child { border-bottom: none; }
@media (max-width: 600px) {
    .summary-card { grid-template-columns: 1fr; }
    .btn-group { flex-direction: column; }
}
</style>
</head>
<body>

<div class="container">
    <h1>â›ï¸ ë§ˆì„ ê³µë™ì€í–‰ ì†ìµê³„ì‚°ì„œ</h1>
    <p class="subtitle">ë§ˆì¸í¬ë˜í”„íŠ¸ ë§ˆì„ ê²½ì˜ì„ ìœ„í•œ ê°„ë‹¨í•œ íšŒê³„ ë„êµ¬</p>

    <div class="info-bar">
        <input type="text" id="villageName" placeholder="ë§ˆì„ ì´ë¦„" oninput="saveData()">
        <input type="date" id="recordDate" oninput="saveData()">
        <input type="text" id="recorder" placeholder="ì‘ì„±ì" oninput="saveData()">
    </div>

    <div class="summary-card">
        <div class="card card-income">
            <div class="card-label">ğŸ’° ì´ ìˆ˜ì…</div>
            <div class="card-value" id="totalIncomeDisplay">0</div>
        </div>
        <div class="card card-expense">
            <div class="card-label">ğŸ’¸ ì´ ì§€ì¶œ</div>
            <div class="card-value" id="totalExpenseDisplay">0</div>
        </div>
        <div class="card card-profit">
            <div class="card-label">ğŸ“Š ìˆœì´ìµ</div>
            <div class="card-value" id="netProfitDisplay">0</div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn btn-save" onclick="saveToHistory()">ğŸ’¾ ê¸°ë¡ ì €ì¥</button>
        <button class="btn btn-export" onclick="exportData()">ğŸ“„ ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-clear" onclick="clearAll()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
    </div>

    <div class="section-title">ğŸ’° ìˆ˜ì… (Income)</div>
    <table id="incomeTable">
        <thead>
            <tr><th>í•­ëª©</th><th>ë‹¨ê°€</th><th>ìˆ˜ëŸ‰</th><th>ì§ì ‘ì…ë ¥</th><th>ì†Œê³„</th><th>ë¹„ê³ </th><th></th></tr>
        </thead>
        <tbody id="incomeBody">
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="4">ìˆ˜ì… í•©ê³„</td>
                <td id="incomeTotal">0</td>
                <td colspan="2"></td>
            </tr>
        </tfoot>
    </table>
    <button class="btn btn-add" onclick="addRow('income')">+ ìˆ˜ì… í•­ëª© ì¶”ê°€</button>

    <div class="section-title">ğŸ’¸ ì§€ì¶œ (Expenses)</div>
    <table id="expenseTable">
        <thead>
            <tr><th>í•­ëª©</th><th>ë‹¨ê°€</th><th>ìˆ˜ëŸ‰</th><th>ì§ì ‘ì…ë ¥</th><th>ì†Œê³„</th><th>ë¹„ê³ </th><th></th></tr>
        </thead>
        <tbody id="expenseBody">
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="4">ì§€ì¶œ í•©ê³„</td>
                <td id="expenseTotal">0</td>
                <td colspan="2"></td>
            </tr>
        </tfoot>
    </table>
    <button class="btn btn-add" onclick="addRow('expense')">+ ì§€ì¶œ í•­ëª© ì¶”ê°€</button>

    <div class="section-title">ğŸ“œ ì €ì¥ëœ ê¸°ë¡</div>
    <div class="history-section">
        <div id="historyList">
            <p style="color: #888; text-align: center;">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<script>
// ê¸°ë³¸ í•­ëª©ë“¤
const defaultIncomeItems = ['ì•„ì´í…œ íŒë§¤', 'ì¬ë£Œ íŒë§¤', 'ì„œë¹„ìŠ¤ ìˆ˜ìˆ˜ë£Œ', 'ë†ì‘ë¬¼ íŒë§¤', 'ê¸°íƒ€ ìˆ˜ì…'];
const defaultExpenseItems = ['ì¬ë£Œ êµ¬ë§¤', 'ì¥ë¹„ êµ¬ë§¤', 'ìˆ˜ë¦¬/ìœ ì§€ë¹„', 'ì¸ê±´ë¹„', 'ê±´ì¶• ìì¬', 'ê¸°íƒ€ ì§€ì¶œ'];

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    if (document.querySelectorAll('#incomeBody tr').length === 0) {
        defaultIncomeItems.forEach(item => addRow('income', item));
    }
    if (document.querySelectorAll('#expenseBody tr').length === 0) {
        defaultExpenseItems.forEach(item => addRow('expense', item));
    }
    loadHistory();
    document.getElementById('recordDate').valueAsDate = new Date();
});

function addRow(type, itemName = '') {
    const tbody = document.getElementById(type + 'Body');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td><input type="text" value="${itemName}" placeholder="í•­ëª©ëª…" oninput="saveData()"></td>
        <td><input type="number" min="0" placeholder="ë‹¨ê°€" oninput="calculate(); saveData()"></td>
        <td><input type="number" min="0" placeholder="ìˆ˜ëŸ‰" oninput="calculate(); saveData()"></td>
        <td><input type="number" min="0" placeholder="ë˜ëŠ” ê¸ˆì•¡" class="direct-input" oninput="calculate(); saveData()"></td>
        <td class="subtotal">0</td>
        <td><input type="text" placeholder="ë©”ëª¨" oninput="saveData()"></td>
        <td><button class="delete-btn" onclick="deleteRow(this)">âœ•</button></td>
    `;
    tbody.appendChild(row);
    calculate();
}

function deleteRow(btn) {
    btn.closest('tr').remove();
    calculate();
    saveData();
}

function calculate() {
    let incomeTotal = 0;
    let expenseTotal = 0;

    // ìˆ˜ì… ê³„ì‚°
    document.querySelectorAll('#incomeBody tr').forEach(row => {
        const inputs = row.querySelectorAll('input[type="number"]');
        const price = parseFloat(inputs[0].value) || 0;
        const qty = parseFloat(inputs[1].value) || 0;
        const direct = parseFloat(inputs[2].value) || 0;
        const subtotal = (price * qty) > 0 ? (price * qty) : direct;
        row.querySelector('.subtotal').textContent = subtotal.toLocaleString();
        incomeTotal += subtotal;
    });

    // ì§€ì¶œ ê³„ì‚°
    document.querySelectorAll('#expenseBody tr').forEach(row => {
        const inputs = row.querySelectorAll('input[type="number"]');
        const price = parseFloat(inputs[0].value) || 0;
        const qty = parseFloat(inputs[1].value) || 0;
        const direct = parseFloat(inputs[2].value) || 0;
        const subtotal = (price * qty) > 0 ? (price * qty) : direct;
        row.querySelector('.subtotal').textContent = subtotal.toLocaleString();
        expenseTotal += subtotal;
    });

    const netProfit = incomeTotal - expenseTotal;

    document.getElementById('incomeTotal').textContent = incomeTotal.toLocaleString();
    document.getElementById('expenseTotal').textContent = expenseTotal.toLocaleString();
    document.getElementById('totalIncomeDisplay').textContent = incomeTotal.toLocaleString();
    document.getElementById('totalExpenseDisplay').textContent = expenseTotal.toLocaleString();
    
    const profitDisplay = document.getElementById('netProfitDisplay');
    profitDisplay.textContent = (netProfit >= 0 ? '+' : '') + netProfit.toLocaleString();
    profitDisplay.style.color = netProfit >= 0 ? '#4CAF50' : '#f44336';
}

function saveData() {
    const data = {
        villageName: document.getElementById('villageName').value,
        recordDate: document.getElementById('recordDate').value,
        recorder: document.getElementById('recorder').value,
        income: getTableData('incomeBody'),
        expense: getTableData('expenseBody')
    };
    localStorage.setItem('villageBank_current', JSON.stringify(data));
}

function getTableData(tbodyId) {
    const rows = [];
    document.querySelectorAll(`#${tbodyId} tr`).forEach(row => {
        const inputs = row.querySelectorAll('input');
        rows.push({
            item: inputs[0].value,
            price: inputs[1].value,
            qty: inputs[2].value,
            direct: inputs[3].value,
            note: inputs[4].value
        });
    });
    return rows;
}

function loadData() {
    const saved = localStorage.getItem('villageBank_current');
    if (saved) {
        const data = JSON.parse(saved);
        document.getElementById('villageName').value = data.villageName || '';
        document.getElementById('recordDate').value = data.recordDate || '';
        document.getElementById('recorder').value = data.recorder || '';
        
        if (data.income && data.income.length > 0) {
            data.income.forEach(item => {
                addRow('income', item.item);
                const lastRow = document.querySelector('#incomeBody tr:last-child');
                const inputs = lastRow.querySelectorAll('input');
                inputs[1].value = item.price && item.price != '0' ? item.price : '';
                inputs[2].value = item.qty && item.qty != '0' ? item.qty : '';
                inputs[3].value = item.direct && item.direct != '0' ? item.direct : '';
                inputs[4].value = item.note || '';
            });
        }
        
        if (data.expense && data.expense.length > 0) {
            data.expense.forEach(item => {
                addRow('expense', item.item);
                const lastRow = document.querySelector('#expenseBody tr:last-child');
                const inputs = lastRow.querySelectorAll('input');
                inputs[1].value = item.price && item.price != '0' ? item.price : '';
                inputs[2].value = item.qty && item.qty != '0' ? item.qty : '';
                inputs[3].value = item.direct && item.direct != '0' ? item.direct : '';
                inputs[4].value = item.note || '';
            });
        }
        calculate();
    }
}

function saveToHistory() {
    const history = JSON.parse(localStorage.getItem('villageBank_history') || '[]');
    const current = JSON.parse(localStorage.getItem('villageBank_current') || '{}');
    
    if (!current.recordDate) {
        alert('ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
    }
    
    current.savedAt = new Date().toISOString();
    current.totalIncome = document.getElementById('incomeTotal').textContent;
    current.totalExpense = document.getElementById('expenseTotal').textContent;
    current.netProfit = document.getElementById('netProfitDisplay').textContent;
    
    history.unshift(current);
    if (history.length > 50) history.pop(); // ìµœëŒ€ 50ê°œ ë³´ê´€
    
    localStorage.setItem('villageBank_history', JSON.stringify(history));
    loadHistory();
    alert('ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…');
}

function loadHistory() {
    const history = JSON.parse(localStorage.getItem('villageBank_history') || '[]');
    const container = document.getElementById('historyList');
    
    if (history.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center;">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    
    container.innerHTML = history.map((item, idx) => `
        <div class="history-item">
            <div>
                <strong>${item.recordDate}</strong> - ${item.villageName || 'ë§ˆì„'}
                <br><small style="color: #888;">ìˆ˜ì…: ${item.totalIncome} | ì§€ì¶œ: ${item.totalExpense} | ìˆœì´ìµ: ${item.netProfit}</small>
            </div>
            <div>
                <button class="btn btn-load" style="padding: 5px 10px; font-size: 0.8em;" onclick="loadFromHistory(${idx})">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button class="delete-btn" onclick="deleteHistory(${idx})">âœ•</button>
            </div>
        </div>
    `).join('');
}

function loadFromHistory(idx) {
    const history = JSON.parse(localStorage.getItem('villageBank_history') || '[]');
    if (history[idx]) {
        localStorage.setItem('villageBank_current', JSON.stringify(history[idx]));
        location.reload();
    }
}

function deleteHistory(idx) {
    if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const history = JSON.parse(localStorage.getItem('villageBank_history') || '[]');
    history.splice(idx, 1);
    localStorage.setItem('villageBank_history', JSON.stringify(history));
    loadHistory();
}

function clearAll() {
    if (!confirm('ëª¨ë“  ì…ë ¥ ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    localStorage.removeItem('villageBank_current');
    location.reload();
}

function exportData() {
    const villageName = document.getElementById('villageName').value || 'ë§ˆì„';
    const recordDate = document.getElementById('recordDate').value || new Date().toISOString().split('T')[0];
    const recorder = document.getElementById('recorder').value || '';
    
    let text = `${villageName} ì†ìµê³„ì‚°ì„œ\n`;
    text += `ë‚ ì§œ: ${recordDate}\n`;
    text += `ì‘ì„±ì: ${recorder}\n\n`;
    
    text += `=== ìˆ˜ì… ===\n`;
    document.querySelectorAll('#incomeBody tr').forEach(row => {
        const inputs = row.querySelectorAll('input');
        const subtotal = row.querySelector('.subtotal').textContent;
        text += `${inputs[0].value}: ${inputs[1].value} x ${inputs[2].value} = ${subtotal} (${inputs[3].value})\n`;
    });
    text += `ìˆ˜ì… í•©ê³„: ${document.getElementById('incomeTotal').textContent}\n\n`;
    
    text += `=== ì§€ì¶œ ===\n`;
    document.querySelectorAll('#expenseBody tr').forEach(row => {
        const inputs = row.querySelectorAll('input');
        const subtotal = row.querySelector('.subtotal').textContent;
        text += `${inputs[0].value}: ${inputs[1].value} x ${inputs[2].value} = ${subtotal} (${inputs[3].value})\n`;
    });
    text += `ì§€ì¶œ í•©ê³„: ${document.getElementById('expenseTotal').textContent}\n\n`;
    
    text += `=== ìš”ì•½ ===\n`;
    text += `ìˆœì´ìµ: ${document.getElementById('netProfitDisplay').textContent}\n`;
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${villageName}_ì†ìµê³„ì‚°ì„œ_${recordDate}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>